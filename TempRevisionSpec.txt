[CODEX/GEMINI PATCH SPEC — 단일 블록 / 엄격 / 무누락 / 오해 방지 / 무단 수정·삭제 금지]

0. 절대 준수(가장 중요)
- 본 문서는 “현재 VSCode에 열려있는 파이썬(PyQt6) 프로그램”에 대한 패치 명세다.
- 본 문서에 명시되지 않은 모든 파일/기능/동작/문구/레이아웃/데이터 스키마/로직/스타일에 대한
  임의 수정, 삭제, 리팩터링, 동작 변경을 전면 금지한다.
- 변경은 반드시 “필요 최소 범위”로만 수행한다.
- 사용자에게 추가 질문 금지. 구현에 필요한 세부사항이 부족하면 합리적 기본값을 채택하고, 코드 주석 + README에 기록한다.
- GUI 프리징 금지: 무거운 연산/I/O/시뮬레이션/시나리오 로드는 워커/스레드/비동기로 처리하고 UI는 즉시 반응해야 한다.
- 기존 Event 시스템/Speed/Signal/ProjectIO/ShipIO 등은 회귀(기능 후퇴/동작 변화) 금지. 새 기능은 “추가”로 구현한다.

1. 목표(이번 패치에서 반드시 구현할 기능)
A) 하단 탭(TabBar) 명칭 변경 + Scenario 탭 추가
B) “Scenario(시나리오)” 기능 추가:
   - 시나리오는 이벤트(Event)의 집합이며, 복잡한 상황 + 대응 조작을 묶어 표현하는 개념이다.
   - 시나리오는 프로젝트(Project)와 독립적으로 저장/로드된다.
   - 사용자는 시나리오를 신규 생성할 수 있고, 시나리오 파일만 열어서 시뮬레이션 시 시각적으로 확인 가능해야 한다.
   - 시나리오 탭에서 “이미 존재하는 이벤트”를 조합하여 시나리오를 만든다.
   - 이벤트가 없으면 사용자는 Event 탭에서 이벤트를 먼저 만들어야 하며, 그 이벤트만 시나리오에 넣을 수 있다.
C) 적용(Enable) 모델:
   - 이벤트를 개별적으로 선박에 enable하여 적용할 수 있어야 한다.
   - 시나리오 단위로도 enable하여 적용할 수 있어야 한다.
D) 표시(가시화):
   - 현재 어떤 이벤트/시나리오가 적용 중(Enable)인지,
   - 또한 “신호 관련 enable 상태(어떤 신호/구문이 포함되는지)”를
     Simulation 화면에서 선박 클릭 시 뜨는 팝업에서 표시한다.
E) 유지보수를 위한 “표준 시나리오 저장 형식”을 정의하고 채택한다.
   - “구문으로 표현된 상황을 시나리오로 변환할 때 기준이 될 만한 형식”이어야 한다.

2. UI 변경 요구사항(필수)
2.1 하단 탭 이름 변경(필수)
- 화면 맨 아래 탭(기존 QTabWidget 또는 유사 컨트롤)의 탭 라벨을 다음으로 변경한다(순서 유지):
  1) Path
  2) Speed
  3) Simulation
  4) Event
- 기존 탭 기능은 그대로 유지하되 “라벨(표시 이름)만” 바꾸는 것이 원칙이다. (무단 재구성 금지)

2.2 5번째 탭 “Scenario” 추가(필수)
- 위 4개 탭 뒤에 5번째 탭으로 “Scenario”를 추가한다.
- Scenario 탭은 본 명세의 Scenario 기능 UI를 제공한다.

3. Scenario 기능 정의(필수)
3.1 Scenario의 본질/저장 단위(필수)
- Scenario는 프로젝트와 독립된 파일로 저장된다.
- Scenario 파일은 프로젝트를 열지 않아도 로드 가능해야 한다.
- Scenario는 “이벤트 참조(조합)”를 포함한다.
- Scenario는 “어떤 선박에 적용할지(스코프)” 정보를 포함할 수 있다(아래 표준 형식 참조).

3.2 Scenario 생성 규칙(필수)
- Scenario 탭에서 “New Scenario”를 만들 때:
  - 사용자는 프로그램 내에 “이미 존재하는 이벤트 목록”에서 이벤트를 선택하여 조합한다.
  - 새로운 이벤트 정의/생성은 Scenario 탭에서 하지 않는다(금지).
  - 필요한 이벤트가 없다면 Event 탭에서 먼저 생성해야 하며,
    Scenario 탭에서는 Event 탭에 의해 생성된 이벤트만 선택 가능해야 한다.

3.3 Enable(적용) 모델 — 이벤트/시나리오 동시 지원(필수)
- 이벤트 단위 enable:
  - 사용자는 특정 Ship에 대해 특정 Event를 enable/disable 할 수 있다.
- 시나리오 단위 enable:
  - 사용자는 Scenario 전체를 enable/disable 할 수 있다.
  - Scenario enable 시, Scenario에 포함된 이벤트들이 “Scenario가 정의한 스코프 규칙”에 따라 적용된다.
- 충돌 규칙(질문 금지, 합리적 기본값 강제):
  - “Ship별 이벤트 enable”과 “Scenario enable”이 동시에 걸릴 수 있다.
  - 기본 정책: 최종 적용 이벤트 집합 = (Scenario로부터 활성화된 이벤트) ∪ (Ship별로 enable된 이벤트)
  - 동일 Event가 중복되면 1회만 적용(집합 처리).
  - disable 우선 정책이 필요하다면:
    - 기본값은 “명시적 disable이 있으면 제외”로 한다. (단, 기존 시스템에 disable 개념이 없다면 추가하되 최소 변경)
  - 채택한 규칙은 README에 5~10줄로 명시한다.

3.4 시뮬레이션 반영(필수)
- Simulation Run 중 timestep마다:
  - “현재 활성 이벤트 집합”을 평가/발화한다(기존 Event 시스템과 연결).
  - Scenario는 자체적으로 조건을 평가하지 않는다. Scenario는 단지 “어떤 이벤트들을 활성화할지”를 결정하는 컨테이너다.
- 이벤트의 기존 실행/발화 로직을 바꾸지 말고, “활성 이벤트 소스가 Scenario에서도 올 수 있다”는 연결만 추가한다.

4. “선박 클릭 팝업” 표시 요구(필수)
4.1 Simulation 화면에서 선박 클릭 시 팝업(기존 팝업이 있으면 확장, 없으면 최소 구현)
- 해당 선박에 대해 아래 정보를 표시:
  - Ship 식별: index + name
  - Enabled Events:
    - (A) Ship별로 enable된 이벤트 목록
    - (B) 현재 enable된 Scenario(들)로부터 적용되는 이벤트 목록
    - 최종 적용 이벤트 목록(집합)도 함께 표기(권장)
  - Enabled Signals:
    - 현재 Signal 생성에서 포함되는 talker/sentence 구문 상태 요약
    - (예: GP 포함 토글 상태, AI/RA 각 sentence dropout 확률 적용 상태 등)
- UI는 간단한 리스트 형태면 충분하나, “현재 적용중인 이벤트/시나리오/신호”가 사용자가 즉시 이해 가능해야 한다.

5. Scenario 표준 저장 형식(필수 — 유지보수 목적)
5.1 파일 형식 선택(질문 금지, 강제)
- 시나리오 파일은 JSON(.scenario.json 또는 .json)으로 저장한다.
- UTF-8 고정.
- “사람이 읽고 쓰기 쉬운” 구조로 한다.

5.2 표준 스키마(필수 — 아래 키는 누락 금지)
- 최상위:
  - schema_version: string (예: "1.0")  // 향후 확장 대비
  - scenario_id: string (uuid 권장)
  - name: string
  - description: string (optional 가능)
  - created_utc: ISO8601 UTC Z
  - modified_utc: ISO8601 UTC Z
  - event_refs: array of objects (필수)
  - scope: object (필수)
  - enable_defaults: object (optional, 없으면 합리적 기본값)

- event_refs[] 각 원소:
  - ref_id: string (시나리오 내 고유 id)
  - event_id: string (Event 정의의 고유 id; 기존 시스템이 idx만 쓰면 그 방식 유지)
  - alias: string (표시용 이름; 없으면 event name)
  - enabled: bool (시나리오 내부에서 해당 이벤트를 기본 enable할지)
  - parameters_override: object|null
    - 기본값: null
    - 이벤트가 “파라미터를 갖는 구조”라면 여기서 override 가능하도록 확장 포인트 제공
    - 단, 기존 이벤트 파라미터 시스템을 무단 변경하지 말고 “override가 있다면 우선 적용” 정도만 최소 연결

- scope:
  - mode: string enum ["ALL_SHIPS", "OWN_ONLY", "TARGET_ONLY", "SELECTED_SHIPS"]
  - ship_ids: array (mode가 SELECTED_SHIPS일 때만 사용; ship index 또는 ship uuid 중 기존 시스템 방식 유지)
- enable_defaults:
  - apply_to_new_ships: bool (새 ship 추가 시 자동 적용 여부; 기본 false)
  - priority: int (충돌 해결용; 기본 0)  // 실제로 사용 안 해도 필드 유지 가능

5.3 Event 정의와의 분리(필수)
- Scenario 파일에는 “이벤트 정의 자체”를 복제해서 저장하지 않는다(금지).
- Scenario는 이벤트를 “참조(event_id)”만 한다.
- 이로써 프로젝트와 독립적인 “재사용 가능한 조합”이 된다.
- 단, 이벤트 정의 파일이 프로젝트 내부에만 존재한다면:
  - Scenario 파일 로드 시 “이벤트 참조를 해석하기 위해” 이벤트 라이브러리가 필요하다.
  - 이 경우 기본 정책(질문 금지):
    - 프로그램은 “Event Library(이벤트 저장소)” 개념을 도입한다.
    - 이벤트는 프로젝트와 별개로 저장될 수 있어야 한다(권장).
    - 최소 구현: 프로그램 실행 폴더에 events_library.json 같은 중앙 저장 파일을 두고,
      Event 탭에서 만든 이벤트는 그 라이브러리에 저장/로드한다.
    - 이미 이벤트 저장 구조가 있다면 그 구조를 유지하고, Scenario는 그 이벤트 저장소를 참조한다.
  - 어떤 방식을 택했는지 README에 명시한다.

6. Scenario 탭 UI 요구(필수)
- Scenario 탭에는 최소 다음 구성요소가 있어야 한다(레이아웃 자유, 단 기존 UI를 크게 흔들지 말 것):
  1) Scenario 파일 관리:
     - [New Scenario], [Open Scenario], [Save Scenario], [Save As] 버튼(또는 메뉴 액션)
  2) Scenario 메타:
     - name 입력/표시
     - description(옵션)
     - scope 설정 UI:
       - mode 선택 콤보박스(ALL_SHIPS/OWN_ONLY/TARGET_ONLY/SELECTED_SHIPS)
       - SELECTED_SHIPS일 경우 ship 선택 리스트(인덱스+이름 표시)
  3) 이벤트 조합 영역:
     - “사용 가능한 이벤트 목록”(Event 탭에서 만든 이벤트들이 표시됨)
     - “Scenario에 포함된 이벤트 목록”(추가/삭제/순서변경 가능 여부는 자유)
     - 포함된 이벤트는 enabled 토글 가능
  4) Scenario enable/disable:
     - [Enable Scenario] 토글(또는 체크박스)
     - enable 시 Simulation에 즉시 반영(다음 timestep부터)

- 사용 가능한 이벤트가 0개일 때:
  - Scenario 탭은 “Event 탭에서 이벤트를 먼저 생성하라”는 안내를 표시한다(질문 금지).

7. 시뮬레이션에서의 시각적 확인(필수)
- Scenario가 enable되어 이벤트가 적용되는 경우:
  - Simulation 화면에서 “현재 어떤 Scenario가 활성인지” 확인 가능해야 한다.
  - 최소 구현: Ship 클릭 팝업에 활성 시나리오 이름 목록 표시.
  - 추가(권장): Simulation 탭 상단/사이드에 “Active Scenario: …” 요약 표시(단, 기존 레이아웃 무단 변경 금지).

8. 무단 변경 금지(재강조)
- 본 문서에 명시되지 않은:
  - 기존 탭 기능 내용
  - Speed/Signal 생성 로직
  - CSV 스키마(시나리오 저장용 JSON 제외)
  - 드롭아웃/GP 토글/UTM 처리/ProjectInfo/ShipPath disable 규칙 등
  에 대한 임의 변경을 금지한다.
- 단, “Scenario 기능 구현을 위해 필수인 최소 추가”는 허용한다(예: events_library.json 도입 등).
  이 경우에도 기존 동작을 깨지 않게 하고 README에 명시한다.

9. 완료 기준(필수)
- 하단 탭 라벨이 Path/Speed/Simulation/Event로 변경되어 있다.
- 5번째 탭 Scenario가 추가되어 있고, New/Open/Save가 가능하다.
- Scenario는 이벤트를 “참조 조합”하여 구성되며, Scenario 탭에서 이벤트를 새로 만들 수 없다.
- 이벤트가 없으면 Scenario 탭에서 안내가 나온다.
- 이벤트는 Ship별 enable 가능, Scenario 단위 enable 가능, 둘 다 동작한다.
- Simulation에서 선박 클릭 팝업에:
  - 적용중(Enable) 이벤트 목록
  - 적용중(Enable) 시나리오(들)
  - 신호 enable 상태 요약
  이 표시된다.
- Scenario 파일(JSON)은 본 문서의 표준 스키마를 만족한다.
- UI 프리징 없이 동작하며, 오류 시 QMessageBox로 안내 후 앱이 계속 동작한다.

[끝]
